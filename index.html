<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloudflare IP Data</title>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        h1 {
            color: var(--text-main);
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            text-align: center;
            font-weight: 700;
        }

        /* 状态栏 */
        .status-bar {
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #ecfdf5;
            border-left: 4px solid var(--success-color);
            color: #065f46;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        /* 控制区域 */
        .controls {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        select, input {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            outline: none;
            transition: border-color 0.2s;
            width: 100%;
            box-sizing: border-box;
        }

        select:focus, input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* 按钮样式 */
        button#btnStart {
            grid-column: 1 / -1;
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 5px;
        }

        button#btnStart:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        button:disabled {
            background-color: #9ca3af !important;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 进度条 */
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 10px;
            margin: 20px 0;
            height: 20px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(45deg, var(--primary-color) 25%, #60a5fa 25%, #60a5fa 50%, var(--primary-color) 50%, var(--primary-color) 75%, #60a5fa 75%, #60a5fa);
            background-size: 20px 20px;
            animation: stripe 1s linear infinite;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 11px;
            transition: width 0.3s ease;
        }

        @keyframes stripe {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        /* 选项卡 */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 内容区块 */
        .section-box {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
        }

        .section-box h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .badge {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: normal;
        }

        /* 表格样式 */
        .scroll-table, .scroll-table-lg {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .scroll-table { max-height: 300px; }
        .scroll-table-lg { max-height: 500px; }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            font-size: 14px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f3f4f6; }

        /* 小按钮样式 */
        .action-btn {
            padding: 6px 12px;
            background-color: var(--warning-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
        }
        
        .action-btn:hover { opacity: 0.9; }
        .action-btn.selected { background-color: var(--success-color); }
        .action-btn:disabled { background-color: #d1d5db; color: #9ca3af; }

        /* 点击复制的样式 */
        .copy-ip {
            cursor: pointer;
            border-bottom: 1px dashed #9ca3af;
            position: relative;
            transition: all 0.2s;
        }
        .copy-ip:hover {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .copy-ip:active {
            opacity: 0.7;
        }

        /* 日志窗口 */
        .log-box {
            height: 200px;
            overflow-y: auto;
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: var(--radius);
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
            line-height: 1.4;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        /* 状态标签 */
        .test-status { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .test-status.testing { background: #fef3c7; color: #d97706; }
        .test-status.done { background: #d1fae5; color: #059669; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; border-radius: 8px; }
            h1 { font-size: 1.25rem; }
            .controls { grid-template-columns: 1fr 1fr; padding: 15px; }
            button#btnStart { margin-top: 10px; }
            th, td { padding: 10px; font-size: 13px; }
        }

        @media (max-width: 480px) {
            .controls { grid-template-columns: 1fr; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cloudflare IP Data</h1>
        
        <div class="status-bar" id="status">正在连接服务器...</div>
        
        <!-- 统一任务页面 -->
        <div class="controls">
            <div class="form-group">
                <label>IP类型</label>
                <select id="ipType">
                    <option value="4">IPv4</option>
                    <option value="6">IPv6</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>并发数</label>
                <input type="number" id="scanThreads" value="100" placeholder="默认100">
            </div>

            <div class="form-group">
                <label>端口</label>
                <select id="testPort">
                    <optgroup label="HTTPS (默认)">
                        <option value="443" selected>443</option>
                        <option value="2053">2053</option>
                        <option value="2083">2083</option>
                        <option value="2087">2087</option>
                        <option value="2096">2096</option>
                        <option value="8443">8443</option>
                    </optgroup>
                    <optgroup label="HTTP">
                        <option value="80">80</option>
                        <option value="8080">8080</option>
                        <option value="8880">8880</option>
                        <option value="2052">2052</option>
                        <option value="2082">2082</option>
                        <option value="2086">2086</option>
                        <option value="2095">2095</option>
                    </optgroup>
                </select>
            </div>

            <div class="form-group">
                <label>延迟阈值(ms)</label>
                <input type="number" id="testDelay" value="500" placeholder="默认500">
            </div>

            <div class="form-group">
                <label>测速 URL</label>
                <input type="text" id="speedUrl" value="speed.cloudflare.com/__down?bytes=100000000" placeholder="默认 speed.cloudflare.com/__down?bytes=100000000">
            </div>

            <div class="form-group">
                <label>最低下载速度 (MB/s)</label>
                <input type="number" id="minSpeed" value="0" step="0.1" min="0" placeholder="0表示不过滤">
            </div>
            
            <button onclick="startUnifiedTask()" id="btnStart">开始扫描与测试</button>
            <button onclick="resetSpeedUrl()" id="btnResetSpeed" style="background-color:#6b7280;color:#fff;padding:10px;font-size:13px;border:none;border-radius:6px;cursor:pointer;">恢复默认测速 URL</button>
        </div>
        
        <div class="progress-container" id="progressBox">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('scan')">扫描结果</div>
            <div class="tab" onclick="switchTab('test')">详细测试</div>
        </div>

        <!-- 扫描结果页面 -->
        <div id="scan" class="tab-content active">
            <!-- 数据中心汇总 -->
            <div class="section-box" id="dcSection" style="display:none;">
                <h3>
                    数据中心汇总 
                    <span class="badge" id="dcCount">0</span>
                    <span id="currentTestDC" class="test-status" style="display:none;"></span>
                </h3>
                <p style="margin: 0 0 15px 0; color: var(--text-secondary); font-size: 13px;">
                    点击下方"选择测试"对指定数据中心的IP进行详细测速。
                </p>
                <div class="scroll-table">
                    <table id="dcTable">
                        <thead>
                            <tr>
                                <th>数据中心</th>
                                <th>地区</th>
                                <th>城市</th>
                                <th>IP数量</th>
                                <th>最低延迟</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- 实时扫描结果 -->
            <div class="section-box">
                <h3>实时扫描结果 <span class="badge" id="scanCount">0</span></h3>
                <div class="scroll-table-lg">
                    <table id="scanTable">
                        <thead>
                            <tr>
                                <th>IP地址 (点击复制)</th>
                                <th>数据中心</th>
                                <th>地区</th>
                                <th>城市</th>
                                <th>延迟</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 详细测试结果页面 -->
        <div id="test" class="tab-content">
            <div class="section-box">
                <h3>
                    详细测试结果 
                    <span class="badge" id="testCount">0</span>
                    <span id="testingDC" style="margin-left: auto; color: var(--text-secondary); font-size: 12px; font-weight: normal;"></span>
                </h3>
                <div style="margin: 0 0 15px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                        点击"测速"按钮对单个IP进行下载速度测试。点击IP可复制。
                    </p>
                    <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                        <label style="font-size: 12px; color: var(--text-secondary);">过滤速度:</label>
                        <input type="number" id="filterSpeed" value="0" step="0.1" min="0" placeholder="MB/s" style="width: 80px; padding: 6px; font-size: 12px;">
                        <button onclick="filterBySpeed()" style="padding: 6px 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">过滤</button>
                        <button onclick="clearSpeedFilter()" style="padding: 6px 12px; background-color: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">清除</button>
                    </div>
                </div>
                <div class="scroll-table-lg">
                    <table id="testTable">
                        <thead>
                            <tr>
                                <th>IP地址</th>
                                <th>丢包率</th>
                                <th>最小延迟</th>
                                <th>最大延迟</th>
                                <th>平均延迟</th>
                                <th>下载速度</th>
                                <th>测速</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="log-box" id="logBox">
            <div>[系统] 等待操作...</div>
        </div>
    </div>

    <script>
        let ws;
        let scanResultsCount = 0;
        let testResultsCount = 0;
        let dcList = []; 
        let currentTestingDC = ''; 
        let testedDCs = new Set(); 
        
        let scanData = [];
        let testData = [];
        let allTestData = []; // 存储所有测试数据用于过滤
        let speedFilterValue = 0;

        function connect() {
            ws = new WebSocket("ws://" + window.location.host + "/ws");
            
            ws.onopen = () => {
                updateStatus("已连接服务器", true);
                log("已连接到服务器");
            };
            
            ws.onclose = () => {
                updateStatus("连接断开，3秒后重连...", false);
                log("连接断开，正在重连...");
                setTimeout(connect, 3000);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleMessage(msg);
            };
        }

        function handleMessage(msg) {
            switch(msg.type) {
                case 'log':
                    log(msg.data);
                    break;
                case 'scan_progress':
                    updateProgress(msg.data.current, msg.data.total, "扫描中");
                    break;
                case 'scan_result':
                    addScanResult(msg.data);
                    break;
                case 'scan_complete_wait_dc':
                    sortAndRenderScanResults();
                    showDCSelection(msg.data);
                    break;
                case 'test_progress':
                    updateProgress(msg.data.current, msg.data.total, "测试中");
                    break;
                case 'test_result':
                    // 实时显示结果，但不存储用于排序（等待后端完整结果）
                    addTestResult(msg.data);
                    break;
                case 'test_complete':
                    // 接收后端排序好的完整数据
                    allTestData = msg.data;
                    testData = msg.data;
                    renderAllTestResults();
                    onTestComplete();
                    break;
                case 'speed_test_result':
                    updateSpeedResult(msg.data);
                    break;
                case 'task_complete':
                    log("任务全部完成");
                    resetButton("开始扫描与测试");
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressBar').textContent = '完成';
                    break;
                case 'error':
                    log("错误: " + msg.data);
                    resetButton("开始扫描与测试");
                    
                    const pb = document.getElementById('progressBar');
                    pb.style.background = '#ef4444';
                    pb.style.width = '100%';
                    pb.textContent = '任务失败';
                    break;
            }
        }
        
        function resetButton(text) {
            const btn = document.getElementById('btnStart');
            btn.disabled = false;
            btn.textContent = text;
        }

        function startUnifiedTask() {
            const ipType = parseInt(document.getElementById('ipType').value);
            const threads = parseInt(document.getElementById('scanThreads').value) || 100;
            const port = parseInt(document.getElementById('testPort').value);
            const delay = parseInt(document.getElementById('testDelay').value) || 500;
            const speedUrlInput = document.getElementById('speedUrl');
            const speedUrl = speedUrlInput.value.trim();
            try {
                if (speedUrl) {
                    localStorage.setItem('cfdata_speed_url', speedUrl);
                    if (window.Android && typeof Android.saveSpeedUrl === 'function') {
                        Android.saveSpeedUrl(speedUrl);
                    }
                }
            } catch (e) {}
            
            const btn = document.getElementById('btnStart');
            btn.disabled = true;
            btn.textContent = "扫描进行中...";
            
            document.querySelector('#scanTable tbody').innerHTML = '';
            document.querySelector('#testTable tbody').innerHTML = '';
            document.querySelector('#dcTable tbody').innerHTML = '';
            document.getElementById('dcSection').style.display = 'none';
            
            const pb = document.getElementById('progressBar');
            pb.style.background = ''; 
            pb.style.backgroundColor = '';
            
            scanResultsCount = 0;
            testResultsCount = 0;
            dcList = [];
            testedDCs.clear();
            currentTestingDC = '';
            
            scanData = [];
            testData = [];
            allTestData = [];
            
            updateBadge('scanCount', 0);
            updateBadge('testCount', 0);
            updateBadge('dcCount', 0);
            
            switchTab('scan');

            const payload = {
                type: 'start_task',
                data: { ipType, threads, port, delay }
            };
            if (speedUrl) {
                payload.data.speedUrl = speedUrl;
            }

            ws.send(JSON.stringify(payload));
            
            document.getElementById('progressBox').style.display = 'block';
            updateProgress(0, 100, "准备中");
        }
        
        function showDCSelection(data) {
            dcList = data;
            renderDCTable();
            
            document.getElementById('dcSection').style.display = 'block';
            resetButton("重新开始扫描");
            document.getElementById('progressBar').textContent = '扫描完成，请选择数据中心';
            
            log("扫描完成，已按延迟排序，等待选择数据中心");
            document.getElementById('dcSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function renderDCTable() {
            const tbody = document.querySelector('#dcTable tbody');
            tbody.innerHTML = '';
            
            dcList.forEach(dc => {
                const isTested = testedDCs.has(dc.DataCenter);
                const isTesting = currentTestingDC === dc.DataCenter;
                
                let btnHtml;
                if (isTesting) {
                    btnHtml = `<button class="action-btn" disabled>测试中...</button>`;
                } else if (isTested) {
                    btnHtml = `<button class="action-btn selected" onclick="selectDC('${dc.DataCenter}')">重新测试</button>`;
                } else {
                    btnHtml = `<button class="action-btn" onclick="selectDC('${dc.DataCenter}')">选择测试</button>`;
                }
                
                const row = `<tr id="dc-row-${dc.DataCenter}">
                    <td><strong>${dc.DataCenter}</strong></td>
                    <td>${dc.Region || ''}</td>
                    <td>${dc.City}</td>
                    <td>${dc.IPCount}</td>
                    <td>${dc.MinLatency} ms</td>
                    <td>${btnHtml}</td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
            
            updateBadge('dcCount', dcList.length);
        }

        function selectDC(dc) {
            const port = parseInt(document.getElementById('testPort').value);
            const delay = parseInt(document.getElementById('testDelay').value);
            
            document.querySelector('#testTable tbody').innerHTML = '';
            testResultsCount = 0;
            updateBadge('testCount', 0);
            
            testData = [];
            allTestData = [];
            speedFilterValue = 0;
            document.getElementById('filterSpeed').value = '0';
            
            currentTestingDC = dc;
            renderDCTable();
            
            document.getElementById('testingDC').textContent = `当前: ${dc}`;
            
            const statusSpan = document.getElementById('currentTestDC');
            statusSpan.textContent = `测试中: ${dc}`;
            statusSpan.className = 'test-status testing';
            statusSpan.style.display = 'inline-block';
            
            ws.send(JSON.stringify({
                type: 'start_test',
                data: { dc, port, delay }
            }));
            
            log("开始测试数据中心: " + dc);
            switchTab('test');
        }
        
        function onTestComplete() {
            if (currentTestingDC) {
                testedDCs.add(currentTestingDC);
                log(`数据中心 ${currentTestingDC} 测试完成，已排序`);
            }
            
            currentTestingDC = '';
            renderDCTable();
            
            const statusSpan = document.getElementById('currentTestDC');
            statusSpan.textContent = '当前测试完成';
            statusSpan.className = 'test-status done';
            
            document.getElementById('progressBar').textContent = '测试完成';
        }

        function runSpeedTest(ip) {
            const ipId = ip.replace(/:/g, '_').replace(/\./g, '_');
            const btn = document.getElementById('btn-speed-' + ipId);
            const speedDisplay = document.getElementById('speed-display-' + ipId);
            
            if(btn) {
                btn.innerHTML = "⏳ 测速中...";
                btn.disabled = true;
                btn.style.backgroundColor = "#4b5563"; 
                btn.style.color = "#ffffff";
            }
            
            if(speedDisplay) {
                speedDisplay.textContent = "测速中...";
                speedDisplay.style.color = "#f59e0b";
            }
            
            const port = parseInt(document.getElementById('testPort').value);
            const speedUrlInput = document.getElementById('speedUrl');
            const speedUrl = speedUrlInput ? speedUrlInput.value.trim() : "";
            const minSpeed = parseFloat(document.getElementById('minSpeed').value) || 0;

            if (speedUrl) {
                try {
                    localStorage.setItem('cfdata_speed_url', speedUrl);
                    if (window.Android && typeof Android.saveSpeedUrl === 'function') {
                        Android.saveSpeedUrl(speedUrl);
                    }
                } catch (e) {}
            }

            ws.send(JSON.stringify({
                type: 'start_speed_test',
                data: { ip, port, speedUrl, minSpeed }
            }));
        }

        // 复制 IP 功能
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = "已复制!";
                element.style.color = "var(--success-color)";
                element.style.fontWeight = "bold";
                
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.color = "";
                    element.style.fontWeight = "";
                }, 1000);
            }).catch(err => {
                console.error('Copy failed', err);
            });
        }

        function resetSpeedUrl() {
            const input = document.getElementById('speedUrl');
            if (!input) return;
            const def = "speed.cloudflare.com/__down?bytes=100000000";
            input.value = def;
            try {
                localStorage.removeItem('cfdata_speed_url');
                if (window.Android && typeof Android.saveSpeedUrl === 'function') {
                    Android.saveSpeedUrl(def);
                }
            } catch (e) {}
            log("已恢复默认测速 URL");
        }

        function addScanResult(res) {
            scanResultsCount++;
            updateBadge('scanCount', scanResultsCount);
            scanData.push(res);
            renderScanRow(res);
        }

        function renderScanRow(res) {
            const row = `<tr>
                <td><span class="copy-ip" onclick="copyToClipboard('${res.IP}', this)" title="点击复制IP">${res.IP}</span></td>
                <td>${res.DataCenter}</td>
                <td>${res.Region}</td>
                <td>${res.City}</td>
                <td><span style="color:${getLatencyColor(res.LatencyStr)}">${res.LatencyStr}</span></td>
            </tr>`;
            
            const tbody = document.querySelector('#scanTable tbody');
            if(tbody.children.length > 500) tbody.removeChild(tbody.firstChild);
            tbody.insertAdjacentHTML('beforeend', row);
        }

        function sortAndRenderScanResults() {
            scanData.sort((a, b) => {
                return parseFloat(a.LatencyStr) - parseFloat(b.LatencyStr);
            });

            const tbody = document.querySelector('#scanTable tbody');
            tbody.innerHTML = ''; 

            scanData.forEach(res => {
                const row = `<tr>
                    <td><span class="copy-ip" onclick="copyToClipboard('${res.IP}', this)" title="点击复制IP">${res.IP}</span></td>
                    <td>${res.DataCenter}</td>
                    <td>${res.Region}</td>
                    <td>${res.City}</td>
                    <td><span style="color:${getLatencyColor(res.LatencyStr)}">${res.LatencyStr}</span></td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        function addTestResult(res) {
            testResultsCount++;
            updateBadge('testCount', testResultsCount);
            // 实时渲染一行
            renderTestRow(res);
        }

        // 新增：渲染所有测试结果（用于后端排序后的完整刷新）
        function renderAllTestResults() {
            const tbody = document.querySelector('#testTable tbody');
            tbody.innerHTML = ''; 
            // 这里的 testData 已经是后端排好序的了
            testData.forEach(res => {
                renderTestRow(res);
            });
            updateBadge('testCount', testData.length);
        }

        function renderTestRow(res) {
            const ipId = res.IP.replace(/:/g, '_').replace(/\./g, '_');
            const avgLat = (res.AvgLatency / 1000000).toFixed(0);
            const speedValue = res.Speed ? parseFloat(res.Speed) : null;
            const speedDisplay = res.Speed || '-';
            const speedColor = speedValue !== null ? (speedValue > 10 ? '#10b981' : speedValue > 5 ? '#f59e0b' : '#ef4444') : '';
            
            const row = `<tr data-speed="${speedValue !== null ? speedValue : -1}">
                <td><span class="copy-ip" onclick="copyToClipboard('${res.IP}', this)" title="点击复制IP" style="font-weight:500">${res.IP}</span></td>
                <td>${(res.LossRate * 100).toFixed(0)}%</td>
                <td>${(res.MinLatency / 1000000).toFixed(0)} ms</td>
                <td>${(res.MaxLatency / 1000000).toFixed(0)} ms</td>
                <td style="color:${getLatencyColor(avgLat)}">${avgLat} ms</td>
                <td id="speed-display-${ipId}" style="color:${speedColor};font-weight:500">${speedDisplay}</td>
                <td id="speed-cell-${ipId}">
                    <button class="action-btn" id="btn-speed-${ipId}" onclick="runSpeedTest('${res.IP}')">测速</button>
                </td>
            </tr>`;
            document.querySelector('#testTable tbody').insertAdjacentHTML('beforeend', row);
        }
        
        function getLatencyColor(latencyStr) {
            const latency = parseFloat(latencyStr);
            if(isNaN(latency)) return 'inherit';
            if(latency < 100) return '#10b981'; 
            if(latency < 200) return '#f59e0b'; 
            return '#ef4444'; 
        }

        function updateSpeedResult(data) {
            const ipId = data.ip.replace(/:/g, '_').replace(/\./g, '_');
            const speedCell = document.getElementById('speed-cell-' + ipId);
            const speedDisplay = document.getElementById('speed-display-' + ipId);
            
            if (data.speed.includes('MB/s')) {
                const val = parseFloat(data.speed);
                let color = '#1f2937';
                if(val > 10) color = '#10b981';
                else if(val > 5) color = '#f59e0b';
                else color = '#ef4444';
                
                // 更新显示列
                if (speedDisplay) {
                    speedDisplay.textContent = data.speed;
                    speedDisplay.style.color = color;
                }
                
                // 更新按钮列，显示测速按钮
                if (speedCell) {
                    speedCell.innerHTML = `<button class="action-btn" id="btn-speed-${ipId}" onclick="runSpeedTest('${data.ip}')">重新测速</button>`;
                }
                
                // 更新数据
                const row = document.querySelector(`tr[data-speed]`);
                if (row) {
                    const tr = document.querySelector(`tr:has(#speed-display-${ipId})`);
                    if (tr) {
                        tr.setAttribute('data-speed', val.toString());
                    }
                }
                
                // 更新testData中的速度
                const testItem = testData.find(item => item.IP === data.ip);
                if (testItem) {
                    testItem.Speed = data.speed;
                }
                const allItem = allTestData.find(item => item.IP === data.ip);
                if (allItem) {
                    allItem.Speed = data.speed;
                }
            } else {
                if (speedDisplay) {
                    speedDisplay.textContent = data.speed;
                    speedDisplay.style.color = '#ef4444';
                }
                if (speedCell) {
                    speedCell.innerHTML = `<button class="action-btn" id="btn-speed-${ipId}" onclick="runSpeedTest('${data.ip}')">重新测速</button>`;
                }
            }
        }
        
        function filterBySpeed() {
            const minSpeed = parseFloat(document.getElementById('filterSpeed').value) || 0;
            speedFilterValue = minSpeed;
            
            if (minSpeed <= 0) {
                testData = [...allTestData];
            } else {
                testData = allTestData.filter(item => {
                    if (!item.Speed) return false;
                    const speed = parseFloat(item.Speed);
                    return !isNaN(speed) && speed >= minSpeed;
                });
            }
            
            renderAllTestResults();
            updateBadge('testCount', testData.length);
            log(`已过滤：显示下载速度 >= ${minSpeed} MB/s 的IP (共 ${testData.length} 个)`);
        }
        
        function clearSpeedFilter() {
            document.getElementById('filterSpeed').value = '0';
            speedFilterValue = 0;
            testData = [...allTestData];
            renderAllTestResults();
            updateBadge('testCount', testData.length);
            log('已清除速度过滤');
        }
        
        function updateBadge(id, count) {
            document.getElementById(id).textContent = count;
        }

        function updateProgress(current, total, statusText) {
            const bar = document.getElementById('progressBar');
            const percent = Math.round((current / total) * 100) + '%';
            bar.style.width = percent;
            bar.textContent = `${statusText} ${percent}`;
        }

        function updateStatus(text, connected) {
            const el = document.getElementById('status');
            el.textContent = text;
            if(connected) {
                el.style.borderLeftColor = 'var(--success-color)';
                el.style.background = '#ecfdf5';
                el.style.color = '#065f46';
            } else {
                el.style.borderLeftColor = '#ef4444';
                el.style.background = '#fef2f2';
                el.style.color = '#991b1b';
            }
        }

        function log(text) {
            const box = document.getElementById('logBox');
            const time = new Date().toLocaleTimeString();
            box.innerHTML += `<div><span style="opacity:0.6">[${time}]</span> ${text}</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const tabs = document.querySelectorAll('.tab');
            if(tabId === 'scan') {
                tabs[0].classList.add('active');
            } else {
                tabs[1].classList.add('active');
            }
            
            document.getElementById(tabId).classList.add('active');
        }

        // 初始化
        (function init() {
            try {
                const saved = localStorage.getItem('cfdata_speed_url');
                if (saved) {
                    const input = document.getElementById('speedUrl');
                    if (input) input.value = saved;
                }
            } catch (e) {}
            connect();
        })();
    </script>
</body>
</html>
