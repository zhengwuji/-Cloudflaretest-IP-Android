name: 构建并发布 APK

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'README.md'
      - '*.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Go 环境
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: 安装 gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        gomobile init
        
    - name: 设置 Java 环境
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 设置 Android SDK
      uses: android-actions/setup-android@v2
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk-version: '25.1.8937393'
      
    - name: 缓存 Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: 下载 Gradle Wrapper
      run: |
        mkdir -p gradle/wrapper
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "下载 Gradle Wrapper JAR..."
          wget -q https://services.gradle.org/distributions/gradle-8.2-bin.zip -O /tmp/gradle.zip || \
          curl -L https://services.gradle.org/distributions/gradle-8.2-bin.zip -o /tmp/gradle.zip
          unzip -q /tmp/gradle.zip -d /tmp/
          cp /tmp/gradle-8.2/lib/gradle-wrapper-*.jar gradle/wrapper/gradle-wrapper.jar || \
          wget -q https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar || \
          curl -L https://raw.githubusercontent.com/gradle/gradle/v8.2.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar
        fi
        
    - name: 创建 Gradle Wrapper 脚本
      run: |
        cat > gradlew << 'EOF'
        #!/bin/sh
        GRADLE_WRAPPER_JAR="gradle/wrapper/gradle-wrapper.jar"
        if [ ! -f "$GRADLE_WRAPPER_JAR" ]; then
          echo "错误: Gradle wrapper jar 未找到"
          exit 1
        fi
        exec java -jar "$GRADLE_WRAPPER_JAR" "$@"
        EOF
        chmod +x gradlew
      
    - name: 编译 Go 库 (arm64)
      run: |
        mkdir -p app/libs
        $HOME/go/bin/gomobile bind -target=android/arm64 -o app/libs/cfdata-arm64.aar ./cfdata
        
    - name: 编译 Go 库 (arm)
      run: |
        $HOME/go/bin/gomobile bind -target=android/arm -o app/libs/cfdata-arm.aar ./cfdata || echo "arm架构编译失败，跳过"
        
    - name: 编译 Go 库 (x86)
      run: |
        $HOME/go/bin/gomobile bind -target=android/386 -o app/libs/cfdata-386.aar ./cfdata || echo "x86架构编译失败，跳过"
        
    - name: 编译 Go 库 (x86_64)
      run: |
        $HOME/go/bin/gomobile bind -target=android/amd64 -o app/libs/cfdata-amd64.aar ./cfdata || echo "x86_64架构编译失败，跳过"
        
    - name: 提取 Native 库
      run: |
        mkdir -p app/src/main/jniLibs
        
        # 提取 arm64
        if [ -f "app/libs/cfdata-arm64.aar" ]; then
          unzip -q -o app/libs/cfdata-arm64.aar -d app/libs/temp-arm64/ || true
          if [ -d "app/libs/temp-arm64/jni/arm64-v8a" ]; then
            cp -r app/libs/temp-arm64/jni/arm64-v8a app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-arm64
          cp app/libs/cfdata-arm64.aar app/libs/cfdata.aar
        fi
        
        # 提取 arm
        if [ -f "app/libs/cfdata-arm.aar" ]; then
          unzip -q -o app/libs/cfdata-arm.aar -d app/libs/temp-arm/ || true
          if [ -d "app/libs/temp-arm/jni/armeabi-v7a" ]; then
            cp -r app/libs/temp-arm/jni/armeabi-v7a app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-arm
        fi
        
        # 提取 x86
        if [ -f "app/libs/cfdata-386.aar" ]; then
          unzip -q -o app/libs/cfdata-386.aar -d app/libs/temp-386/ || true
          if [ -d "app/libs/temp-386/jni/x86" ]; then
            cp -r app/libs/temp-386/jni/x86 app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-386
        fi
        
        # 提取 x86_64
        if [ -f "app/libs/cfdata-amd64.aar" ]; then
          unzip -q -o app/libs/cfdata-amd64.aar -d app/libs/temp-amd64/ || true
          if [ -d "app/libs/temp-amd64/jni/x86_64" ]; then
            cp -r app/libs/temp-amd64/jni/x86_64 app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-amd64
        fi
        
    - name: 构建 APK
      id: build
      run: |
        chmod +x gradlew || true
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        echo "开始构建APK..."
        ./gradlew clean assembleRelease --no-daemon --stacktrace || {
          echo "Gradle wrapper failed, trying direct gradle..."
          gradle clean assembleRelease --no-daemon --stacktrace || {
            echo "构建失败"
            exit 1
          }
        }
        
        # 检查APK文件是否存在
        APK_PATH="app/build/outputs/apk/release/app-release.apk"
        if [ -f "$APK_PATH" ]; then
          echo "APK构建成功: $APK_PATH"
          ls -lh "$APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "build_success=true" >> $GITHUB_OUTPUT
        else
          echo "错误: APK文件不存在: $APK_PATH"
          echo "查找所有APK文件:"
          find app/build/outputs -name "*.apk" -type f || true
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: 生成更新日志
      id: changelog
      if: steps.build.outputs.build_success == 'true'
      run: |
        DATE=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG=$(git log -1 --pretty=%B || echo "代码更新")
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "commit=$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
    - name: 查找APK文件
      id: find_apk
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "查找APK文件..."
        echo "检查标准路径: app/build/outputs/apk/release/app-release.apk"
        
        # 首先检查标准路径
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_FILE="app/build/outputs/apk/release/app-release.apk"
          echo "找到APK文件: $APK_FILE"
          ls -lh "$APK_FILE"
          echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        else
          echo "标准路径不存在，搜索所有APK文件..."
          APK_FILE=$(find app/build/outputs -name "*.apk" -type f 2>/dev/null | head -1)
          if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
            echo "找到APK文件: $APK_FILE"
            ls -lh "$APK_FILE"
            echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "错误: 未找到任何APK文件"
            echo "搜索目录内容:"
            find app/build/outputs -type f 2>/dev/null | head -20 || true
            exit 1
          fi
        fi
        
        # 验证文件大小
        APK_SIZE=$(stat -f%z "$APK_FILE" 2>/dev/null || stat -c%s "$APK_FILE" 2>/dev/null || echo "0")
        echo "APK文件大小: $APK_SIZE 字节"
        if [ "$APK_SIZE" -lt 1000000 ]; then
          echo "警告: APK文件可能不完整（小于1MB）"
        fi
        
    - name: 创建 Release
      if: steps.build.outputs.build_success == 'true' && steps.find_apk.outputs.apk_file != ''
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}-${{ steps.changelog.outputs.sha }}
        name: 版本 v${{ github.run_number }} - ${{ steps.changelog.outputs.date }}
        body: |
          ## 更新日志
          
          **更新日期**: ${{ steps.changelog.outputs.date }}
          
          **提交信息**: ${{ steps.changelog.outputs.commit }}
          
          **构建编号**: #${{ github.run_number }}
          
          **提交哈希**: ${{ steps.changelog.outputs.sha }}
          
          ---
          
          ### 功能特性
          
          - ✅ IP扫描和延迟测试
          - ✅ 下载速度测试
          - ✅ 最低下载速度过滤
          - ✅ 自定义测速URL
          - ✅ 多架构支持 (arm64-v8a, armeabi-v7a, x86, x86_64)
          
          ### 安装说明
          
          1. 下载 APK 文件
          2. 在设备上允许安装未知来源应用
          3. 安装并运行
          
        files: |
          ${{ steps.find_apk.outputs.apk_file }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 构建失败通知
      if: steps.build.outputs.build_success != 'true'
      run: |
        echo "构建失败，未创建Release"
        exit 1

