name: 构建并发布 APK

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'README.md'
      - '*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 错误收集文件
    env:
      ERROR_LOG: /tmp/build_errors.log
    
    steps:
    - name: 初始化错误日志
      run: |
        echo "==========================================" > $ERROR_LOG
        echo "构建错误日志 - $(date)" >> $ERROR_LOG
        echo "==========================================" >> $ERROR_LOG
        echo "" >> $ERROR_LOG
        
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Go 环境
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: 安装 gomobile
      run: |
        echo "安装 gomobile..." | tee -a $ERROR_LOG
        go install golang.org/x/mobile/cmd/gomobile@latest || {
          echo "错误: gomobile 安装失败" | tee -a $ERROR_LOG
          exit 1
        }
        echo "初始化 gomobile..." | tee -a $ERROR_LOG
        gomobile init || {
          echo "错误: gomobile 初始化失败" | tee -a $ERROR_LOG
          exit 1
        }
        echo "✓ gomobile 安装成功" | tee -a $ERROR_LOG
        
    - name: 设置 Java 环境
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 安装 aria2（加速下载）
      run: |
        echo "安装 aria2 以加速下载..." | tee -a $ERROR_LOG
        sudo apt-get update -qq
        sudo apt-get install -y aria2 || {
          echo "警告: aria2 安装失败，将使用默认下载工具" | tee -a $ERROR_LOG
        }
        aria2 --version || echo "aria2 未安装"
        

        
    - name: 安装 Android SDK 组件
      id: setup_android
      uses: android-actions/setup-android@v3
      continue-on-error: true
      with:
        packages: |
          platform-tools
          platforms;android-34
          build-tools;34.0.0
          ndk;25.1.8937393
        accept-android-sdk-licenses: true
      env:
        ERROR_LOG: ${{ env.ERROR_LOG }}
        
    - name: 验证 Android SDK 安装
      run: |
        echo "==========================================" | tee -a $ERROR_LOG
        echo "验证 Android SDK 安装" | tee -a $ERROR_LOG
        echo "==========================================" | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
        # 列出已安装的组件（用于调试）
        echo "已安装的 SDK 组件:" | tee -a $ERROR_LOG
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list_installed 2>&1 | tee -a $ERROR_LOG || true
        echo "" | tee -a $ERROR_LOG
        
        # 验证关键组件是否真的存在（不依赖action的返回状态）
        echo "验证关键组件:" | tee -a $ERROR_LOG
        MISSING_COMPONENTS=0
        
        if [ -d "$ANDROID_SDK_ROOT/platform-tools" ]; then
          echo "  ✓ platform-tools: 已安装" | tee -a $ERROR_LOG
        else
          echo "  ❌ platform-tools: 未找到" | tee -a $ERROR_LOG
          MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
        fi
        
        if [ -d "$ANDROID_SDK_ROOT/platforms/android-34" ]; then
          echo "  ✓ platforms;android-34: 已安装" | tee -a $ERROR_LOG
        else
          echo "  ❌ platforms;android-34: 未找到" | tee -a $ERROR_LOG
          MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
        fi
        
        if [ -d "$ANDROID_SDK_ROOT/build-tools/34.0.0" ]; then
          echo "  ✓ build-tools;34.0.0: 已安装" | tee -a $ERROR_LOG
        else
          echo "  ❌ build-tools;34.0.0: 未找到" | tee -a $ERROR_LOG
          MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
        fi
        
        # 检查NDK（多个版本中任意一个即可）
        NDK_FOUND=0
        if [ -d "$ANDROID_SDK_ROOT/ndk/25.1.8937393" ]; then
          echo "  ✓ ndk;25.1.8937393: 已安装" | tee -a $ERROR_LOG
          NDK_FOUND=1
        else
          # 查找任何可用的NDK版本
          NDK_DIR=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | grep -E "ndk/[0-9]" | head -1)
          if [ -n "$NDK_DIR" ]; then
            NDK_VERSION=$(basename "$NDK_DIR")
            echo "  ✓ ndk;$NDK_VERSION: 已安装（使用备选版本）" | tee -a $ERROR_LOG
            NDK_FOUND=1
          else
            echo "  ❌ NDK: 未找到任何版本" | tee -a $ERROR_LOG
            MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
          fi
        fi
        
        echo "" | tee -a $ERROR_LOG
        
        # 只有在关键组件真的缺失时才报错
        if [ $MISSING_COMPONENTS -gt 0 ]; then
          echo "❌ 错误: 缺少 $MISSING_COMPONENTS 个关键SDK组件" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          echo "Action 返回状态: ${{ steps.setup_android.outcome }}" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          exit 1
        fi
        
        echo "✓ 所有关键SDK组件都已安装" | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
    - name: 配置 Android NDK 环境变量
      run: |
        echo "配置 Android NDK 环境变量..." | tee -a $ERROR_LOG
        export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
        export NDK_HOME=$ANDROID_NDK_HOME
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
        
        # 验证 NDK 路径
        if [ -d "$ANDROID_NDK_HOME" ]; then
          echo "✓ NDK 路径有效: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
          ls -la "$ANDROID_NDK_HOME" | head -5
        else
          echo "警告: NDK 路径不存在，查找可用的 NDK..." | tee -a $ERROR_LOG
          find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | head -5 || true
        fi
      
    - name: 设置 Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.5'

      
    - name: 编译 Go 库 (arm64)
      run: |
        echo "==========================================" | tee -a $ERROR_LOG
        echo "编译 Go 库 (arm64)" | tee -a $ERROR_LOG
        echo "==========================================" | tee -a $ERROR_LOG
        
        mkdir -p app/libs
        
        # 设置环境变量
        export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
        export NDK_HOME=$ANDROID_NDK_HOME
        
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT" | tee -a $ERROR_LOG
        
        # 检查 NDK
        if [ ! -d "$ANDROID_NDK_HOME" ]; then
          echo "警告: NDK 路径不存在，查找可用的 NDK..." | tee -a $ERROR_LOG
          # 优先查找指定版本的 NDK
          AVAILABLE_NDK=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | grep -E "ndk/25\.1\.8937393" | head -1)
          if [ -z "$AVAILABLE_NDK" ]; then
            # 如果找不到指定版本，查找其他兼容版本（25.x）
            AVAILABLE_NDK=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | grep -E "ndk/25\." | head -1)
          fi
          if [ -z "$AVAILABLE_NDK" ]; then
            # 最后尝试查找任何 NDK
            AVAILABLE_NDK=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | grep -E "ndk/[0-9]" | head -1)
          fi
          if [ -n "$AVAILABLE_NDK" ]; then
            echo "找到可用 NDK: $AVAILABLE_NDK" | tee -a $ERROR_LOG
            export ANDROID_NDK_HOME=$AVAILABLE_NDK
            export NDK_HOME=$AVAILABLE_NDK
            echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
            echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
          else
            echo "错误: 未找到可用的 NDK" | tee -a $ERROR_LOG
            exit 1
          fi
        fi
        
        echo "使用 NDK: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
        
        # 设置 Android API 级别（gomobile 需要）
        export ANDROID_API=21
        echo "ANDROID_API=$ANDROID_API" >> $GITHUB_ENV
        
        # 验证 NDK 版本
        if [ -f "$ANDROID_NDK_HOME/source.properties" ]; then
          echo "NDK 版本信息:" | tee -a $ERROR_LOG
          grep "Pkg.Revision" "$ANDROID_NDK_HOME/source.properties" | tee -a $ERROR_LOG || true
        fi
        
        # 编译（指定 API 级别）
        echo "开始编译 arm64 架构（API 级别: $ANDROID_API）..." | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        echo "执行命令: gomobile bind -target=android/arm64 -androidapi=$ANDROID_API -o app/libs/cfdata-arm64.aar ." | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
        $HOME/go/bin/gomobile bind -target=android/arm64 -androidapi=$ANDROID_API -o app/libs/cfdata-arm64.aar . 2>&1 | tee -a $ERROR_LOG || {
          echo "" | tee -a $ERROR_LOG
          echo "❌ 错误: arm64 架构编译失败" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          echo "环境信息:" | tee -a $ERROR_LOG
          echo "  ANDROID_HOME: $ANDROID_HOME" | tee -a $ERROR_LOG
          echo "  ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT" | tee -a $ERROR_LOG
          echo "  ANDROID_NDK_HOME: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
          echo "  NDK_HOME: $NDK_HOME" | tee -a $ERROR_LOG
          echo "  ANDROID_API: $ANDROID_API" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          exit 1
        }
        
        if [ -f "app/libs/cfdata-arm64.aar" ]; then
          echo "" | tee -a $ERROR_LOG
          echo "✓ arm64 编译成功" | tee -a $ERROR_LOG
          ls -lh app/libs/cfdata-arm64.aar | tee -a $ERROR_LOG
        else
          echo "" | tee -a $ERROR_LOG
          echo "❌ 错误: arm64 AAR 文件未生成" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          exit 1
        fi
        
    # 注释掉其他架构以避免重复类冲突
    # arm64是现代Android设备的主流架构
    # - name: 编译 Go 库 (arm)
    #   continue-on-error: true
    #   run: |
    #     echo "==========================================" | tee -a $ERROR_LOG
    #     echo "编译 Go 库 (arm)" | tee -a $ERROR_LOG
    #     echo "==========================================" | tee -a $ERROR_LOG
    #     export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
    #     export NDK_HOME=$ANDROID_NDK_HOME
    #     export ANDROID_API=${ANDROID_API:-21}
    #     echo "开始编译 arm 架构（API 级别: $ANDROID_API）..." | tee -a $ERROR_LOG
    #     $HOME/go/bin/gomobile bind -target=android/arm -androidapi=$ANDROID_API -o app/libs/cfdata-arm.aar . 2>&1 | tee -a $ERROR_LOG || {
    #       echo "警告: arm架构编译失败，跳过" | tee -a $ERROR_LOG
    #     }
    #     
    # - name: 编译 Go 库 (x86)
    #   continue-on-error: true
    #   run: |
    #     echo "==========================================" | tee -a $ERROR_LOG
    #     echo "编译 Go 库 (x86)" | tee -a $ERROR_LOG
    #     echo "==========================================" | tee -a $ERROR_LOG
    #     export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
    #     export NDK_HOME=$ANDROID_NDK_HOME
    #     export ANDROID_API=${ANDROID_API:-21}
    #     echo "开始编译 x86 架构（API 级别: $ANDROID_API）..." | tee -a $ERROR_LOG
    #     $HOME/go/bin/gomobile bind -target=android/386 -androidapi=$ANDROID_API -o app/libs/cfdata-386.aar . 2>&1 | tee -a $ERROR_LOG || {
    #       echo "警告: x86架构编译失败，跳过" | tee -a $ERROR_LOG
    #     }
    #     
    # - name: 编译 Go 库 (x86_64)
    #   continue-on-error: true
    #   run: |
    #     echo "==========================================" | tee -a $ERROR_LOG
    #     echo "编译 Go 库 (x86_64)" | tee -a $ERROR_LOG
    #     echo "==========================================" | tee -a $ERROR_LOG
    #     export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
    #     export NDK_HOME=$ANDROID_NDK_HOME
    #     export ANDROID_API=${ANDROID_API:-21}
    #     echo "开始编译 x86_64 架构（API 级别: $ANDROID_API）..." | tee -a $ERROR_LOG
    #     $HOME/go/bin/gomobile bind -target=android/amd64 -androidapi=$ANDROID_API -o app/libs/cfdata-amd64.aar . 2>&1 | tee -a $ERROR_LOG || {
    #       echo "警告: x86_64架构编译失败，跳过" | tee -a $ERROR_LOG
    #     }
    #     
    - name: 提取 Native 库
      run: |
        mkdir -p app/src/main/jniLibs
        
        # 提取 arm64
        if [ -f "app/libs/cfdata-arm64.aar" ]; then
          unzip -q -o app/libs/cfdata-arm64.aar -d app/libs/temp-arm64/ || true
          if [ -d "app/libs/temp-arm64/jni/arm64-v8a" ]; then
            cp -r app/libs/temp-arm64/jni/arm64-v8a app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-arm64
          cp app/libs/cfdata-arm64.aar app/libs/cfdata.aar
        fi
        
        # 提取 arm
        if [ -f "app/libs/cfdata-arm.aar" ]; then
          unzip -q -o app/libs/cfdata-arm.aar -d app/libs/temp-arm/ || true
          if [ -d "app/libs/temp-arm/jni/armeabi-v7a" ]; then
            cp -r app/libs/temp-arm/jni/armeabi-v7a app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-arm
        fi
        
        # 提取 x86
        if [ -f "app/libs/cfdata-386.aar" ]; then
          unzip -q -o app/libs/cfdata-386.aar -d app/libs/temp-386/ || true
          if [ -d "app/libs/temp-386/jni/x86" ]; then
            cp -r app/libs/temp-386/jni/x86 app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-386
        fi
        
        # 提取 x86_64
        if [ -f "app/libs/cfdata-amd64.aar" ]; then
          unzip -q -o app/libs/cfdata-amd64.aar -d app/libs/temp-amd64/ || true
          if [ -d "app/libs/temp-amd64/jni/x86_64" ]; then
            cp -r app/libs/temp-amd64/jni/x86_64 app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-amd64
        fi
        
    - name: 生成签名密钥库
      run: |
        echo "===========================================" | tee -a $ERROR_LOG
        echo "生成签名密钥库" | tee -a $ERROR_LOG
        echo "===========================================" | tee -a $ERROR_LOG
        
        # 创建密钥库目录
        mkdir -p app
        
        # 生成密钥库（使用keytool）
        keytool -genkeypair \
          -alias cfdata \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=CFData, OU=CFData, O=CFData, L=Beijing, ST=Beijing, C=CN" \
          -keystore app/release.keystore \
          -storepass cfdata123456 \
          -keypass cfdata123456 \
          -storetype pkcs12 || {
            echo "错误: 密钥库生成失败" | tee -a $ERROR_LOG
            exit 1
          }
        
        echo "✓ 密钥库生成成功" | tee -a $ERROR_LOG
        ls -lh app/release.keystore | tee -a $ERROR_LOG
        
        # 设置环境变量供Gradle使用
        echo "KEYSTORE_FILE=$PWD/app/release.keystore" >> $GITHUB_ENV
        echo "KEYSTORE_PASSWORD=cfdata123456" >> $GITHUB_ENV
        echo "KEY_ALIAS=cfdata" >> $GITHUB_ENV
        echo "KEY_PASSWORD=cfdata123456" >> $GITHUB_ENV
        
    - name: 构建 APK
      id: build
      run: |
        echo "==========================================" | tee -a $ERROR_LOG
        echo "构建 APK" | tee -a $ERROR_LOG
        echo "==========================================" | tee -a $ERROR_LOG
        
        chmod +x gradlew || true
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        echo "ANDROID_HOME: $ANDROID_HOME" | tee -a $ERROR_LOG
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
        
        echo "开始构建APK..." | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        echo "执行命令: gradle clean assembleRelease --no-daemon --stacktrace" | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
        # 捕获完整的Gradle输出
        set +e  # 临时禁用错误退出
        gradle clean assembleRelease --no-daemon --stacktrace 2>&1 | tee -a $ERROR_LOG
        GRADLE_EXIT_CODE=$?
        set -e  # 重新启用错误退出
        
        if [ $GRADLE_EXIT_CODE -ne 0 ]; then
          echo "" | tee -a $ERROR_LOG
          echo "❌ Gradle 构建失败 (退出码: $GRADLE_EXIT_CODE)" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          echo "Gradle 版本信息:" | tee -a $ERROR_LOG
          gradle --version 2>&1 | tee -a $ERROR_LOG || true
          echo "" | tee -a $ERROR_LOG
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "" | tee -a $ERROR_LOG
        
        # 检查APK文件是否存在（支持签名和未签名版本）
        APK_PATH="app/build/outputs/apk/release/app-release.apk"
        UNSIGNED_APK="app/build/outputs/apk/release/app-release-unsigned.apk"
        
        if [ -f "$APK_PATH" ]; then
          echo "✓ 找到签名APK: $APK_PATH" | tee -a $ERROR_LOG
          ls -lh "$APK_PATH" | tee -a $ERROR_LOG
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "build_success=true" >> $GITHUB_OUTPUT
        elif [ -f "$UNSIGNED_APK" ]; then
          echo "✓ 找到未签名APK: $UNSIGNED_APK" | tee -a $ERROR_LOG
          ls -lh "$UNSIGNED_APK" | tee -a $ERROR_LOG
          echo "apk_path=$UNSIGNED_APK" >> $GITHUB_OUTPUT
          echo "build_success=true" >> $GITHUB_OUTPUT
        else
          echo "❌ 错误: 未找到APK文件" | tee -a $ERROR_LOG
          echo "查找所有APK文件:" | tee -a $ERROR_LOG
          find app/build/outputs -name "*.apk" -type f 2>&1 | tee -a $ERROR_LOG || true
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: 生成更新日志
      id: changelog
      if: steps.build.outputs.build_success == 'true'
      run: |
        DATE=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG=$(git log -1 --pretty=%B || echo "代码更新")
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "commit=$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
    - name: 查找APK文件
      id: find_apk
      if: steps.build.outputs.build_success == 'true'
      run: |
        echo "查找APK文件..."
        echo "检查标准路径: app/build/outputs/apk/release/app-release.apk"
        
        # 首先检查标准路径
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_FILE="app/build/outputs/apk/release/app-release.apk"
          echo "找到APK文件: $APK_FILE"
          ls -lh "$APK_FILE"
          echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        else
          echo "标准路径不存在，搜索所有APK文件..."
          APK_FILE=$(find app/build/outputs -name "*.apk" -type f 2>/dev/null | head -1)
          if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
            echo "找到APK文件: $APK_FILE"
            ls -lh "$APK_FILE"
            echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
          else
            echo "错误: 未找到任何APK文件"
            echo "搜索目录内容:"
            find app/build/outputs -type f 2>/dev/null | head -20 || true
            exit 1
          fi
        fi
        
        # 验证文件大小
        APK_SIZE=$(stat -f%z "$APK_FILE" 2>/dev/null || stat -c%s "$APK_FILE" 2>/dev/null || echo "0")
        echo "APK文件大小: $APK_SIZE 字节"
        if [ "$APK_SIZE" -lt 1000000 ]; then
          echo "警告: APK文件可能不完整（小于1MB）"
        fi
        
    - name: 创建 Release
      if: steps.build.outputs.build_success == 'true' && steps.find_apk.outputs.apk_file != ''
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}-${{ steps.changelog.outputs.sha }}
        name: 版本 v${{ github.run_number }} - ${{ steps.changelog.outputs.date }}
        body: |
          ## 更新日志
          
          **更新日期**: ${{ steps.changelog.outputs.date }}
          
          **提交信息**: ${{ steps.changelog.outputs.commit }}
          
          **构建编号**: #${{ github.run_number }}
          
          **提交哈希**: ${{ steps.changelog.outputs.sha }}
          
          ---
          
          ### 功能特性
          
          - ✅ IP扫描和延迟测试
          - ✅ 下载速度测试
          - ✅ 最低下载速度过滤
          - ✅ 自定义测速URL
          - ✅ 多架构支持 (arm64-v8a, armeabi-v7a, x86, x86_64)
          
          ### 安装说明
          
          1. 下载 APK 文件
          2. 在设备上允许安装未知来源应用
          3. 安装并运行
          
        files: |
          ${{ steps.find_apk.outputs.apk_file }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 显示错误日志汇总
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "构建错误日志汇总"
        echo "=========================================="
        if [ -f "$ERROR_LOG" ]; then
          cat $ERROR_LOG
        else
          echo "未找到错误日志文件"
        fi
        echo "=========================================="
        
    - name: 上传错误日志
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-error-log
        path: ${{ env.ERROR_LOG }}
        retention-days: 7
        
    - name: 构建失败通知
      if: steps.build.outputs.build_success != 'true'
      run: |
        echo ""
        echo "=========================================="
        echo "构建失败！"
        echo "=========================================="
        echo ""
        echo "请查看上方的错误日志汇总，或下载错误日志文件查看详细信息。"
        echo ""
        if [ -f "$ERROR_LOG" ]; then
          echo "主要错误："
          grep -i "error\|失败\|failed" $ERROR_LOG | head -20 || echo "未找到明确的错误信息"
        fi
        echo ""
        exit 1

