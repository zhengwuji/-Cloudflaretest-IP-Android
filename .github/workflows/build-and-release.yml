name: 构建并发布 APK

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'README.md'
      - '*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    # 错误收集文件
    env:
      ERROR_LOG: /tmp/build_errors.log
    
    steps:
    - name: 初始化错误日志
      run: |
        echo "==========================================" > $ERROR_LOG
        echo "构建错误日志 - $(date)" >> $ERROR_LOG
        echo "==========================================" >> $ERROR_LOG
        echo "" >> $ERROR_LOG
        
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Go 环境
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: 安装 gomobile
      run: |
        echo "安装 gomobile..." | tee -a $ERROR_LOG
        go install golang.org/x/mobile/cmd/gomobile@latest || {
          echo "错误: gomobile 安装失败" | tee -a $ERROR_LOG
          exit 1
        }
        echo "初始化 gomobile..." | tee -a $ERROR_LOG
        gomobile init || {
          echo "错误: gomobile 初始化失败" | tee -a $ERROR_LOG
          exit 1
        }
        echo "✓ gomobile 安装成功" | tee -a $ERROR_LOG
        
    - name: 设置 Java 环境
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 安装 aria2（加速下载）
      run: |
        echo "安装 aria2 以加速下载..." | tee -a $ERROR_LOG
        sudo apt-get update -qq
        sudo apt-get install -y aria2 || {
          echo "警告: aria2 安装失败，将使用默认下载工具" | tee -a $ERROR_LOG
        }
        aria2 --version || echo "aria2 未安装"
        

        
    - name: 安装 Android SDK 组件
      id: setup_android
      uses: android-actions/setup-android@v3
      continue-on-error: true
      with:
        packages: |
          platform-tools
          platforms;android-34
          build-tools;34.0.0
          ndk;25.1.8937393
        accept-android-sdk-licenses: true
      env:
        ERROR_LOG: ${{ env.ERROR_LOG }}
        
    - name: 验证 Android SDK 安装
      run: |
        echo "==========================================" | tee -a $ERROR_LOG
        echo "验证 Android SDK 安装" | tee -a $ERROR_LOG
        echo "==========================================" | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
        # 列出已安装的组件（用于调试）
        echo "已安装的 SDK 组件:" | tee -a $ERROR_LOG
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list_installed 2>&1 | tee -a $ERROR_LOG || true
        echo "" | tee -a $ERROR_LOG
        
        # 验证关键组件是否真的存在（不依赖action的返回状态）
        echo "验证关键组件:" | tee -a $ERROR_LOG
        MISSING_COMPONENTS=0
        
        if [ -d "$ANDROID_SDK_ROOT/platform-tools" ]; then
          echo "  ✓ platform-tools: 已安装" | tee -a $ERROR_LOG
        else
          echo "  ❌ platform-tools: 未找到" | tee -a $ERROR_LOG
          MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
        fi
        
        if [ -d "$ANDROID_SDK_ROOT/platforms/android-34" ]; then
          echo "  ✓ platforms;android-34: 已安装" | tee -a $ERROR_LOG
        else
          echo "  ❌ platforms;android-34: 未找到" | tee -a $ERROR_LOG
          MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
        fi
        
        if [ -d "$ANDROID_SDK_ROOT/build-tools/34.0.0" ]; then
          echo "  ✓ build-tools;34.0.0: 已安装" | tee -a $ERROR_LOG
        else
          echo "  ❌ build-tools;34.0.0: 未找到" | tee -a $ERROR_LOG
          MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
        fi
        
        # 检查NDK（多个版本中任意一个即可）
        NDK_FOUND=0
        if [ -d "$ANDROID_SDK_ROOT/ndk/25.1.8937393" ]; then
          echo "  ✓ ndk;25.1.8937393: 已安装" | tee -a $ERROR_LOG
          NDK_FOUND=1
        else
          # 查找任何可用的NDK版本
          NDK_DIR=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | grep -E "ndk/[0-9]" | head -1)
          if [ -n "$NDK_DIR" ]; then
            NDK_VERSION=$(basename "$NDK_DIR")
            echo "  ✓ ndk;$NDK_VERSION: 已安装（使用备选版本）" | tee -a $ERROR_LOG
            NDK_FOUND=1
          else
            echo "  ❌ NDK: 未找到任何版本" | tee -a $ERROR_LOG
            MISSING_COMPONENTS=$((MISSING_COMPONENTS + 1))
          fi
        fi
        
        echo "" | tee -a $ERROR_LOG
        
        # 只有在关键组件真的缺失时才报错
        if [ $MISSING_COMPONENTS -gt 0 ]; then
          echo "❌ 错误: 缺少 $MISSING_COMPONENTS 个关键SDK组件" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          echo "Action 返回状态: ${{ steps.setup_android.outcome }}" | tee -a $ERROR_LOG
          echo "" | tee -a $ERROR_LOG
          exit 1
        fi
        
        echo "✓ 所有关键SDK组件都已安装" | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
    - name: 配置 Android NDK 环境变量
      run: |
        echo "配置 Android NDK 环境变量..." | tee -a $ERROR_LOG
        export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
        export NDK_HOME=$ANDROID_NDK_HOME
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
        
        # 验证 NDK 路径
        if [ -d "$ANDROID_NDK_HOME" ]; then
          echo "✓ NDK 路径有效: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
          ls -la "$ANDROID_NDK_HOME" | head -5
        else
          echo "警告: NDK 路径不存在，查找可用的 NDK..." | tee -a $ERROR_LOG
          find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | head -5 || true
        fi
      
    - name: 设置 Gradle
      uses: gradle/actions/setup-gradle@v4
      with:
        gradle-version: '8.5'

      
        
    - name: 编译多架构 Go 库
      run: |
        echo "===========================================" | tee -a $ERROR_LOG
        echo "编译多架构 Go 库" | tee -a $ERROR_LOG
        echo "===========================================" | tee -a $ERROR_LOG
        
        mkdir -p app/libs
        
        # 设置环境变量
        export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
        export NDK_HOME=$ANDROID_NDK_HOME
        export ANDROID_API=21
        
        # 检查 NDK
        if [ ! -d "$ANDROID_NDK_HOME" ]; then
          echo "警告: NDK 路径不存在，查找可用的 NDK..." | tee -a $ERROR_LOG
          AVAILABLE_NDK=$(find $ANDROID_SDK_ROOT/ndk -maxdepth 1 -type d 2>/dev/null | grep -E "ndk/[0-9]" | head -1)
          if [ -n "$AVAILABLE_NDK" ]; then
            export ANDROID_NDK_HOME=$AVAILABLE_NDK
            export NDK_HOME=$AVAILABLE_NDK
            echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
            echo "NDK_HOME=$NDK_HOME" >> $GITHUB_ENV
          else
            echo "错误: 未找到可用的 NDK" | tee -a $ERROR_LOG
            exit 1
          fi
        fi
        
        echo "使用 NDK: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
        echo "ANDROID_API: $ANDROID_API" | tee -a $ERROR_LOG
        
        # 编译 arm64-v8a
        echo "" | tee -a $ERROR_LOG
        echo "开始编译 arm64-v8a..." | tee -a $ERROR_LOG
        $HOME/go/bin/gomobile bind -target=android/arm64 -androidapi=$ANDROID_API -o app/libs/cfdata-arm64.aar . 2>&1 | tee -a $ERROR_LOG || {
          echo "❌ arm64-v8a 编译失败" | tee -a $ERROR_LOG
          exit 1
        }
        [ -f "app/libs/cfdata-arm64.aar" ] && echo "✓ arm64-v8a 编译成功" | tee -a $ERROR_LOG
        
        # 编译 armeabi-v7a
        echo "" | tee -a $ERROR_LOG
        echo "开始编译 armeabi-v7a..." | tee -a $ERROR_LOG
        $HOME/go/bin/gomobile bind -target=android/arm -androidapi=$ANDROID_API -o app/libs/cfdata-arm.aar . 2>&1 | tee -a $ERROR_LOG || {
          echo "❌ armeabi-v7a 编译失败" | tee -a $ERROR_LOG
          exit 1
        }
        [ -f "app/libs/cfdata-arm.aar" ] && echo "✓ armeabi-v7a 编译成功" | tee -a $ERROR_LOG
        
        # 编译 x86
        echo "" | tee -a $ERROR_LOG
        echo "开始编译 x86..." | tee -a $ERROR_LOG
        $HOME/go/bin/gomobile bind -target=android/386 -androidapi=$ANDROID_API -o app/libs/cfdata-x86.aar . 2>&1 | tee -a $ERROR_LOG || {
          echo "❌ x86 编译失败" | tee -a $ERROR_LOG
          exit 1
        }
        [ -f "app/libs/cfdata-x86.aar" ] && echo "✓ x86 编译成功" | tee -a $ERROR_LOG
        
        # 编译 x86_64
        echo "" | tee -a $ERROR_LOG
        echo "开始编译 x86_64..." | tee -a $ERROR_LOG
        $HOME/go/bin/gomobile bind -target=android/amd64 -androidapi=$ANDROID_API -o app/libs/cfdata-x86_64.aar . 2>&1 | tee -a $ERROR_LOG || {
          echo "❌ x86_64 编译失败" | tee -a $ERROR_LOG
          exit 1
        }
        [ -f "app/libs/cfdata-x86_64.aar" ] && echo "✓ x86_64 编译成功" | tee -a $ERROR_LOG
        
        echo "" | tee -a $ERROR_LOG
        echo "✓ 所有架构编译完成" | tee -a $ERROR_LOG
        ls -lh app/libs/*.aar | tee -a $ERROR_LOG
        
    - name: 提取 Native 库
      run: |
        echo "=========================================="
        echo "提取所有架构的 Native 库到 jniLibs"
        echo "=========================================="
        mkdir -p app/src/main/jniLibs
        
        # arm64-v8a
        echo "提取 arm64-v8a..."
        unzip -q -o app/libs/cfdata-arm64.aar -d app/libs/temp-arm64/
        cp -r app/libs/temp-arm64/jni/arm64-v8a app/src/main/jniLibs/ && echo "✓ arm64-v8a 完成" || echo "✗ arm64-v8a 失败"
        
        # armeabi-v7a
        echo "提取 armeabi-v7a..."
        unzip -q -o app/libs/cfdata-arm.aar -d app/libs/temp-arm/
        cp -r app/libs/temp-arm/jni/armeabi-v7a app/src/main/jniLibs/ && echo "✓ armeabi-v7a 完成" || echo "✗ armeabi-v7a 失败"
        
        # x86
        echo "提取 x86..."
        unzip -q -o app/libs/cfdata-x86.aar -d app/libs/temp-x86/
        cp -r app/libs/temp-x86/jni/x86 app/src/main/jniLibs/ && echo "✓ x86 完成" || echo "✗ x86 失败"
        
        # x86_64
        echo "提取 x86_64..."
        unzip -q -o app/libs/cfdata-x86_64.aar -d app/libs/temp-x86_64/
        cp -r app/libs/temp-x86_64/jni/x86_64 app/src/main/jniLibs/ && echo "✓ x86_64 完成" || echo "✗ x86_64 失败"
        
        # 复制一个 AAR 作为主依赖（提供 Java 类）
        echo "复制 cfdata.aar 用于Gradle依赖..."
        cp app/libs/cfdata-arm64.aar app/libs/cfdata.aar
        ls -lh app/libs/cfdata.aar
        
        echo "=========================================="
        echo "验证 jniLibs 结构："
        echo "=========================================="
        find app/src/main/jniLibs -name "*.so" | while read so_file; do
          echo "  $(du -h "$so_file" | cut -f1) - "$so_file""
        done
        
        echo "=========================================="
        echo "✓ Native库提取完成"
        echo "=========================================="
        
    - name: 生成签名密钥库
      run: |
        echo "===========================================" | tee -a $ERROR_LOG
        echo "生成签名密钥库" | tee -a $ERROR_LOG
        echo "===========================================" | tee -a $ERROR_LOG
        
        # 创建密钥库目录
        mkdir -p app
        
        # 生成密钥库（使用keytool）
        keytool -genkeypair \
          -alias cfdata \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=CFData, OU=CFData, O=CFData, L=Beijing, ST=Beijing, C=CN" \
          -keystore app/release.keystore \
          -storepass cfdata123456 \
          -keypass cfdata123456 \
          -storetype pkcs12 || {
            echo "错误: 密钥库生成失败" | tee -a $ERROR_LOG
            exit 1
          }
        
        echo "✓ 密钥库生成成功" | tee -a $ERROR_LOG
        ls -lh app/release.keystore | tee -a $ERROR_LOG
        
        # 设置环境变量供Gradle使用
        echo "KEYSTORE_FILE=$PWD/app/release.keystore" >> $GITHUB_ENV
        echo "KEYSTORE_PASSWORD=cfdata123456" >> $GITHUB_ENV
        echo "KEY_ALIAS=cfdata" >> $GITHUB_ENV
        echo "KEY_PASSWORD=cfdata123456" >> $GITHUB_ENV
        
    - name: 构建 APK
      id: build
      run: |
        ERROR_LOG="build_error.log"
        echo "==========================================" | tee -a $ERROR_LOG
        echo "构建 APK" | tee -a $ERROR_LOG
        echo "==========================================" | tee -a $ERROR_LOG
        
        chmod +x gradlew || true
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-$ANDROID_SDK_ROOT/ndk/25.1.8937393}
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        echo "ANDROID_HOME: $ANDROID_HOME" | tee -a $ERROR_LOG
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME" | tee -a $ERROR_LOG
        echo "" | tee -a $ERROR_LOG
        
        # 执行Gradle构建
        set +e
        gradle clean assembleRelease --no-daemon --stacktrace 2>&1 | tee -a $ERROR_LOG
        GRADLE_EXIT_CODE=$?
        set -e
        
        if [ $GRADLE_EXIT_CODE -ne 0 ]; then
          echo "" | tee -a $ERROR_LOG
          echo "❌ Gradle 构建失败 (退出码: $GRADLE_EXIT_CODE)" | tee -a $ERROR_LOG
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # Gradle成功，检查APK
        echo "==========================================" | tee -a $ERROR_LOG
        echo "验证APK生成结果" | tee -a $ERROR_LOG
        echo "==========================================" | tee -a $ERROR_LOG
        
        APK_DIR="app/build/outputs/apk/release"
        if [ ! -d "$APK_DIR" ]; then
          echo "❌ 错误: APK输出目录不存在: $APK_DIR" | tee -a $ERROR_LOG
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        APK_COUNT=$(find "$APK_DIR" -name "*.apk" -type f 2>/dev/null | wc -l | tr -d ' ')
        if [ "$APK_COUNT" -eq "0" ]; then
          echo "❌ 错误: 未找到APK文件" | tee -a $ERROR_LOG
          ls -la "$APK_DIR" | tee -a $ERROR_LOG
          echo "build_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "✓ 成功生成 $APK_COUNT 个APK文件:" | tee -a $ERROR_LOG
        find "$APK_DIR" -name "*.apk" -type f -exec ls -lh {} \; | tee -a $ERROR_LOG
        echo "build_success=true" >> $GITHUB_OUTPUT
        
    - name: 生成更新日志
      id: changelog
      if: steps.build.outputs.build_success == 'true'
      run: |
        DATE=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG=$(git log -1 --pretty=%B || echo "代码更新")
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "commit=$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
        
    - name: 创建 Release
      if: steps.build.outputs.build_success == 'true'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ github.run_number }}-${{ steps.changelog.outputs.sha }}
        name: 版本 v${{ github.run_number }} - ${{ steps.changelog.outputs.date }}
        body: |
          ## 更新日志
          
          **更新日期**: ${{ steps.changelog.outputs.date }}
          
          **提交信息**: ${{ steps.changelog.outputs.commit }}
          
          **构建编号**: #${{ github.run_number }}
          
          **提交哈希**: ${{ steps.changelog.outputs.sha }}
          
          ---
          
          ### 功能特性
          
          - ✅ IP扫描和延迟测试
          - ✅ 下载速度测试
          - ✅ 最低下载速度过滤
          - ✅ 自定义测速URL
          - ✅ 自定义测速结果数量
          - ✅ 扫描结果页面显示下载速度
          - ✅ 多架构支持 (arm64-v8a, armeabi-v7a, x86, x86_64, universal)
          
          ### APK 说明
          
          - **com.cfdata-arm64-v8a-release.apk** - 适用于现代64位ARM设备（推荐）
          - **com.cfdata-armeabi-v7a-release.apk** - 适用于32位ARM设备
          - **com.cfdata-x86-release.apk** - 适用于x86模拟器和设备
          - **com.cfdata-x86_64-release.apk** - 适用于64位x86设备
          - **com.cfdata-universal-release.apk** - 通用版本（包含所有架构，体积较大）
          
          ### 安装说明
          
          1. 根据设备架构下载对应的APK文件（不确定可下载universal版本）
          2. 在设备上允许安装未知来源应用
          3. 安装并运行
          
        files: |
          app/build/outputs/apk/release/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 显示错误日志汇总
      if: always()
      run: |
        echo ""
        echo "=========================================="
        echo "构建错误日志汇总"
        echo "=========================================="
        if [ -f "$ERROR_LOG" ]; then
          cat $ERROR_LOG
        else
          echo "未找到错误日志文件"
        fi
        echo "=========================================="
        
    - name: 上传错误日志
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-error-log
        path: ${{ env.ERROR_LOG }}
        retention-days: 7
        
    - name: 构建失败通知
      if: steps.build.outputs.build_success != 'true'
      run: |
        echo ""
        echo "=========================================="
        echo "构建失败！"
        echo "=========================================="
        echo ""
        echo "请查看上方的错误日志汇总，或下载错误日志文件查看详细信息。"
        echo ""
        if [ -f "$ERROR_LOG" ]; then
          echo "主要错误："
          grep -i "error\|失败\|failed" $ERROR_LOG | head -20 || echo "未找到明确的错误信息"
        fi
        echo ""
        exit 1
