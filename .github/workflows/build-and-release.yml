name: 构建并发布 APK

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - 'README.md'
      - '*.md'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Go 环境
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: 安装 gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        gomobile init
        
    - name: 设置 Java 环境
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 设置 Android SDK
      uses: android-actions/setup-android@v2
      
    - name: 缓存 Gradle
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: 授予 gradlew 执行权限
      run: chmod +x gradlew || true
      
    - name: 编译 Go 库 (arm64)
      run: |
        mkdir -p app/libs
        $HOME/go/bin/gomobile bind -target=android/arm64 -o app/libs/cfdata-arm64.aar ./cfdata
        
    - name: 编译 Go 库 (arm)
      run: |
        $HOME/go/bin/gomobile bind -target=android/arm -o app/libs/cfdata-arm.aar ./cfdata || echo "arm架构编译失败，跳过"
        
    - name: 编译 Go 库 (x86)
      run: |
        $HOME/go/bin/gomobile bind -target=android/386 -o app/libs/cfdata-386.aar ./cfdata || echo "x86架构编译失败，跳过"
        
    - name: 编译 Go 库 (x86_64)
      run: |
        $HOME/go/bin/gomobile bind -target=android/amd64 -o app/libs/cfdata-amd64.aar ./cfdata || echo "x86_64架构编译失败，跳过"
        
    - name: 提取 Native 库
      run: |
        mkdir -p app/src/main/jniLibs
        
        # 提取 arm64
        if [ -f "app/libs/cfdata-arm64.aar" ]; then
          unzip -q -o app/libs/cfdata-arm64.aar -d app/libs/temp-arm64/ || true
          if [ -d "app/libs/temp-arm64/jni/arm64-v8a" ]; then
            cp -r app/libs/temp-arm64/jni/arm64-v8a app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-arm64
          cp app/libs/cfdata-arm64.aar app/libs/cfdata.aar
        fi
        
        # 提取 arm
        if [ -f "app/libs/cfdata-arm.aar" ]; then
          unzip -q -o app/libs/cfdata-arm.aar -d app/libs/temp-arm/ || true
          if [ -d "app/libs/temp-arm/jni/armeabi-v7a" ]; then
            cp -r app/libs/temp-arm/jni/armeabi-v7a app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-arm
        fi
        
        # 提取 x86
        if [ -f "app/libs/cfdata-386.aar" ]; then
          unzip -q -o app/libs/cfdata-386.aar -d app/libs/temp-386/ || true
          if [ -d "app/libs/temp-386/jni/x86" ]; then
            cp -r app/libs/temp-386/jni/x86 app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-386
        fi
        
        # 提取 x86_64
        if [ -f "app/libs/cfdata-amd64.aar" ]; then
          unzip -q -o app/libs/cfdata-amd64.aar -d app/libs/temp-amd64/ || true
          if [ -d "app/libs/temp-amd64/jni/x86_64" ]; then
            cp -r app/libs/temp-amd64/jni/x86_64 app/src/main/jniLibs/ || true
          fi
          rm -rf app/libs/temp-amd64
        fi
        
    - name: 构建 APK
      run: |
        chmod +x gradlew || true
        ./gradlew clean assembleRelease --no-daemon
        
    - name: 生成更新日志
      id: changelog
      run: |
        DATE=$(date +'%Y-%m-%d %H:%M:%S')
        COMMIT_MSG=$(git log -1 --pretty=%B || echo "代码更新")
        SHORT_SHA=$(git rev-parse --short HEAD)
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "commit=$COMMIT_MSG" >> $GITHUB_OUTPUT
        echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        
    - name: 创建 Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}-${{ steps.changelog.outputs.sha }}
        name: 版本 v${{ github.run_number }} - ${{ steps.changelog.outputs.date }}
        body: |
          ## 更新日志
          
          **更新日期**: ${{ steps.changelog.outputs.date }}
          
          **提交信息**: ${{ steps.changelog.outputs.commit }}
          
          **构建编号**: #${{ github.run_number }}
          
          **提交哈希**: ${{ steps.changelog.outputs.sha }}
          
          ---
          
          ### 功能特性
          
          - ✅ IP扫描和延迟测试
          - ✅ 下载速度测试
          - ✅ 最低下载速度过滤
          - ✅ 自定义测速URL
          - ✅ 多架构支持 (arm64-v8a, armeabi-v7a, x86, x86_64)
          
          ### 安装说明
          
          1. 下载 APK 文件
          2. 在设备上允许安装未知来源应用
          3. 安装并运行
          
        files: |
          app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

